blueprint:
  name: thermostat icon update via Openweathermap weather conditions codes.
  description: Change thermostat icon when weather code change. Need one automation for day time and one for night time.
  domain: automation
  source_url: https://github.com/claudegel/sinope-zha/tree/master/automation/blueprints/icon_update_open.yaml
  input:
    weather_entity:
      name: Weather_code
      selector:
        entity: openweathermap_weather_code
          domain: sensor
    condition_entity:
      name: sun
      selector:
        entity: sun
          domain: sun
    climate_target:
      name: Thermostat_ieee
      selector:
        target:
          entity: TH1134ZB-HC
            domain: climate

# If weather code change we update the thermostat,
mode: single

trigger_variables:
    weather_change:
      "800": Sun
      "801": Sun2
      "802": Cloudsun
      "803": Cloudsun2
      "500": Cloudrainsun
      "200": Cloudrainsun2
      "501": Cloudrainsun3
      "502": Cloudrainsun4
      "511": Cloudlightning2
      "600": Cloudsnow2
      "804": Cloud2
      "521": Cloudrain2
      "522": Cloudrain3
      "520": Cloudrain
      "201": Cloudlightning
      "202": Cloudlightning
      "616": Cloud
      "615": Cloud
      "300": Cloud3

trigger:
  - platform: state
    entity_id: !input weather_entity
  - platform: sun
    event: sunrize

conditions:
  - condition: state
    entity_id: !input condition_entity
    state: "above_horizon"

variables:
  thermostats:
    - !input climate_target

action:
  - repeat:
      count: "{{thermostats|length}}"
      sequence:
        - action: zha.set_zigbee_cluster_attribute
          data:
            cluster_type: in
            ieee: "{{ thermostats[repeat.index-1] }}"
            endpoint_id: 1
            cluster_id: 0xff01
            attribute: 0x0013
            value: "{{ weather_change.get(states('!input weather_entity'), 'Hide') }}"
